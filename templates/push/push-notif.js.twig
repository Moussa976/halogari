{# templates/push/push-notif.js.twig #}

/**
 * ClÃ© publique VAPID injectÃ©e par Symfony pour lâ€™abonnement Web Push
 */
const VAPID_PUBLIC_KEY = '{{ vapidPublicKey }}';

/**
 * Convertit une clÃ© Base64 URL-safe en Uint8Array (requis pour lâ€™API Push)
 */
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
}

/**
 * Fonction d'abonnement aux notifications Push (Web Push API)
 */
async function subscribeToPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    alert('Notifications non supportÃ©es sur ce navigateur.');
    return;
  }

  const registration = await navigator.serviceWorker.register('/js/service-worker.js');

  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
  });

  const response = await fetch('/abonnement-push', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(subscription)
  });

  if (response.ok) {
    console.log('âœ… Abonnement Push enregistrÃ©');
  } else {
    console.error('âŒ Erreur lors de lâ€™envoi de lâ€™abonnement');
  }
}

/**
 * GÃ¨re lâ€™affichage du popup de notifications + installation PWA sur iOS
 */
document.addEventListener('DOMContentLoaded', () => {
  const ua = navigator.userAgent.toLowerCase();
  const isIos = /iphone|ipad|ipod/.test(ua);
  const isInStandaloneMode = ('standalone' in window.navigator) && window.navigator.standalone;

  // âœ… Guide d'installation iOS (Safari ou Chrome depuis iOS 16.4)
  if (isIos && !isInStandaloneMode) {
    setTimeout(() => {
      Swal.fire({
        icon: 'info',
        title: 'ğŸ“² Installer HaloGari',
        html: `Dans Safari <strong>ou Chrome</strong>, appuyez sur <i class="bi bi-box-arrow-up"></i><br>
               puis sur <strong>Â« Sur lâ€™Ã©cran dâ€™accueil Â»</strong> pour installer lâ€™app.`,
        confirmButtonText: 'OK'
      });
    }, 10000);
  }

  // âœ… Demande de permission push (si pas encore faite)
  if (!localStorage.getItem('pushPermissionAsked')) {
    setTimeout(() => {
      Swal.fire({
        title: 'ğŸ”” Notifications HaloGari',
        html: 'Souhaitez-vous recevoir les notifications pour vos rÃ©servations et messages ?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Oui, activer',
        cancelButtonText: 'Non, refuser',
        allowOutsideClick: false,
        allowEscapeKey: false
      }).then((result) => {
        localStorage.setItem('pushPermissionAsked', '1');
        if (result.isConfirmed) {
          subscribeToPush();
        } else {
          Swal.fire('â„¹ï¸ Notifications dÃ©sactivÃ©es', '', 'info');
        }
      });
    }, 2000);
  }
});
